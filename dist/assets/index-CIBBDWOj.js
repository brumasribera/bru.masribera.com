var R=(d,y,s)=>new Promise((v,b)=>{var p=u=>{try{w(s.next(u))}catch(x){b(x)}},h=u=>{try{w(s.throw(u))}catch(x){b(x)}},w=u=>u.done?v(u.value):Promise.resolve(u.value).then(p,h);w((s=s.apply(d,y)).next())});import{r as o,j as l}from"./index-CK92jQew.js";const I={start:"/timer-sounds/start-gong.mp3",middle:"/timer-sounds/middle-gong.mp3",minute:"/timer-sounds/1m-gong.mp3",end:"/timer-sounds/end-gong.mp3"},j=[{bg:"bg-blue-600",border:"border-blue-400",text:"text-white"},{bg:"bg-green-600",border:"border-green-400",text:"text-white"},{bg:"bg-purple-600",border:"border-purple-400",text:"text-white"},{bg:"bg-orange-600",border:"border-orange-400",text:"text-white"},{bg:"bg-pink-600",border:"border-pink-400",text:"text-white"},{bg:"bg-indigo-600",border:"border-indigo-400",text:"text-white"},{bg:"bg-teal-600",border:"border-teal-400",text:"text-white"},{bg:"bg-red-600",border:"border-red-400",text:"text-white"},{bg:"bg-yellow-600",border:"border-yellow-400",text:"text-black"},{bg:"bg-cyan-600",border:"border-cyan-400",text:"text-white"},{bg:"bg-emerald-600",border:"border-emerald-400",text:"text-white"},{bg:"bg-rose-600",border:"border-rose-400",text:"text-white"},{bg:"bg-violet-600",border:"border-violet-400",text:"text-white"},{bg:"bg-amber-600",border:"border-amber-400",text:"text-black"},{bg:"bg-lime-600",border:"border-lime-400",text:"text-black"},{bg:"bg-sky-600",border:"border-sky-400",text:"text-white"}];function q(){const[d,y]=o.useState(480),[s,v]=o.useState(!1),[b,p]=o.useState(!1),[h,w]=o.useState("v1.1.3"),[u,x]=o.useState("2025-08-27 11:45:00"),g=o.useRef({}),M=o.useRef(!1),k=o.useRef({}),E=o.useRef(null),A=o.useCallback(t=>{const e=t.match(/v?(\d+)\.(\d+)\.(\d+)/);if(!e)return j[0];const i=parseInt(e[1]),n=parseInt(e[2]),r=parseInt(e[3]),a=(i*1e4+n*100+r)%j.length;return j[a]},[]);o.useEffect(()=>{fetch(`/VERSION.json?v=${Date.now()}`).then(t=>t.json()).then(t=>{w(`v${t.version}`),x(t.timestamp)}).catch(t=>{console.warn("Failed to load version info:",t)})},[]),o.useEffect(()=>{document.title="Stretch Timer",setTimeout(()=>{document.title="Stretch Timer"},100);const t=()=>{document.hidden||(document.title="Stretch Timer")};return document.addEventListener("visibilitychange",t),(()=>{document.querySelectorAll("link[rel='manifest']").forEach(m=>m.remove());const a=document.createElement("link");a.rel="manifest",a.href=`/tools/timer/manifest.webmanifest?v=${Date.now()}`,a.setAttribute("data-timer-manifest","true"),document.head.appendChild(a),console.log("Timer manifest set to:",a.href),console.log("Current path:",window.location.pathname)})(),(()=>{[{name:"mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-status-bar-style",content:"black-translucent"},{name:"apple-mobile-web-app-title",content:"Stretch Timer"},{name:"application-name",content:"Stretch Timer"},{name:"msapplication-TileColor",content:"#000000"},{name:"msapplication-config",content:"/browserconfig.xml"},{name:"name",content:"Stretch Timer"},{name:"title",content:"Stretch Timer"}].forEach(a=>{if(!document.querySelector(`meta[name="${a.name}"]`)){const f=document.createElement("meta");f.name=a.name,f.content=a.content,document.head.appendChild(f)}})})(),R(this,null,function*(){if("serviceWorker"in navigator)try{const r=yield navigator.serviceWorker.register("/sw.js");console.log("Timer service worker registered:",r),yield navigator.serviceWorker.ready,E.current=r.active,navigator.serviceWorker.addEventListener("message",N)}catch(r){console.error("Timer service worker registration failed:",r)}}),()=>{const r=document.querySelector("link[data-timer-manifest='true']");r&&r.remove();const a=document.createElement("link");a.rel="manifest",a.href="/site.webmanifest",document.head.appendChild(a),console.log("Restored original manifest:",a.href),["mobile-web-app-capable","apple-mobile-web-app-capable","apple-mobile-web-app-status-bar-style","apple-mobile-web-app-title","application-name","msapplication-TileColor","msapplication-config"].forEach(f=>{const T=document.querySelector(`meta[name="${f}"]`);T&&T.remove()}),document.title="Bru Mas Ribera - Frontend & UX Engineer",document.removeEventListener("visibilitychange",t),"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",N),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(f=>{f.forEach(T=>{T.scope.includes("/tools/timer")&&(T.unregister(),console.log("Timer service worker unregistered"))})})}},[]);const N=o.useCallback(t=>{t.data&&t.data.type==="TIMER_UPDATE"&&(y(t.data.timeLeft),v(t.data.isRunning),p(t.data.isCompleted),t.data.gongType&&S(t.data.gongType))},[]),c=o.useCallback((t,e)=>{E.current&&E.current.postMessage({type:"TIMER_CONTROL",action:t,data:e})},[]);o.useEffect(()=>{(()=>{const n=document.querySelector("link[rel*='icon']");if(n)n.dataset.originalHref||(n.dataset.originalHref=n.href),n.href="/favicons/favicon-timer.svg";else{const r=document.createElement("link");r.type="image/svg+xml",r.rel="icon",r.href="/favicons/favicon-timer.svg",document.head.appendChild(r)}})();let e=!0;return R(this,null,function*(){console.log("ðŸŽµ Starting to load audio files...");for(const[n,r]of Object.entries(I)){if(!e)break;try{if(console.log(`ðŸŽµ Loading audio: ${n} from ${r}`),!(yield fetch(r)).ok){console.warn(`âš ï¸ Audio file not accessible: ${r}`);continue}if(!e)break;const m=O(r);m.addEventListener("error",f=>{console.error(`âŒ Audio loading error for ${n}:`,f)}),m.addEventListener("canplaythrough",()=>{console.log(`âœ… Audio loaded successfully: ${n}`)}),m.addEventListener("pause",()=>{console.log(`â¸ï¸ Audio paused: ${n}`)}),m.addEventListener("play",()=>{console.log(`â–¶ï¸ Audio started: ${n}`)}),m.addEventListener("ended",()=>{console.log(`ðŸ”š Audio ended: ${n}`),H()}),g.current[n]=m,console.log(`âœ… Audio element created for ${n}`)}catch(a){console.error(`âŒ Error loading audio ${n}:`,a)}}console.log(`ðŸŽµ Audio loading complete. Loaded ${Object.keys(g.current).length} files:`,Object.keys(g.current))}),()=>{e=!1;const n=document.querySelector("link[rel*='icon']");n&&n.dataset.originalHref?(n.href=n.dataset.originalHref,delete n.dataset.originalHref):n&&n.href.includes("favicon-timer")&&(n.href="/favicon.ico"),Object.values(g.current).forEach(r=>{r.pause(),r.src=""}),g.current={}}},[]),o.useCallback(()=>{const t=document.querySelectorAll("audio");let e=!1;return k.current={},t.forEach((n,r)=>{!n.hasAttribute("data-timer-audio")&&!n.paused&&(e=!0,k.current[`audio_${r}`]={element:n,wasPlaying:!0,currentTime:n.currentTime,volume:n.volume})}),document.querySelectorAll("video").forEach((n,r)=>{!n.paused&&n.volume>0&&(e=!0,k.current[`video_${r}`]={element:n,wasPlaying:!0,currentTime:n.currentTime,volume:n.volume})}),e},[]);const H=o.useCallback(()=>{M.current&&setTimeout(()=>{Object.values(k.current).forEach(e=>{if(e.wasPlaying&&e.element)try{if(e.element.tagName==="AUDIO"||e.element.tagName==="VIDEO"){e.element.currentTime=e.currentTime,e.element.volume=e.volume;const i=e.element.play();i!==void 0&&i.catch(()=>{})}}catch(i){}});const t=new Event("resume-audio",{bubbles:!0});document.dispatchEvent(t),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="none",navigator.mediaSession.metadata=null),window.dispatchEvent(new Event("focus")),document.dispatchEvent(new Event("visibilitychange")),M.current=!1,k.current={}},100)},[]);o.useCallback(()=>{"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"Timer Gong",artist:"Stretch Timer",album:"Meditation Sounds"}),navigator.mediaSession.playbackState="none",navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",()=>{}),navigator.mediaSession.setActionHandler("stop",()=>{}),navigator.mediaSession.setActionHandler("seekbackward",()=>{}),navigator.mediaSession.setActionHandler("seekforward",()=>{}),navigator.mediaSession.setActionHandler("seekto",()=>{}),navigator.mediaSession.setActionHandler("previoustrack",()=>{}),navigator.mediaSession.setActionHandler("nexttrack",()=>{}))},[]),o.useCallback(()=>{if("mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"Timer Gong",artist:"Stretch Timer",album:"Meditation Sounds"}),navigator.mediaSession.playbackState="none",navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",()=>{}),navigator.mediaSession.setActionHandler("stop",()=>{}),navigator.mediaSession.setActionHandler("seekbackward",()=>{}),navigator.mediaSession.setActionHandler("seekforward",()=>{}),navigator.mediaSession.setActionHandler("seekto",()=>{}),navigator.mediaSession.setActionHandler("previoustrack",()=>{}),navigator.mediaSession.setActionHandler("nexttrack",()=>{}),"setAudioFocusRequest"in navigator.mediaSession))try{navigator.mediaSession.setAudioFocusRequest({audioFocusRequestType:"transient_may_duck"})}catch(t){}},[]);const O=o.useCallback(t=>{const e=new Audio(t);return e.preload="auto",e.volume=.5,e.loop=!1,e.setAttribute("data-timer-audio","true"),e.setAttribute("data-notification-style","true"),e.addEventListener("loadedmetadata",()=>{e.duration>3&&e.addEventListener("timeupdate",()=>{e.currentTime>=3&&(e.pause(),e.currentTime=0)})}),e},[]),C=o.useCallback(t=>{try{const e=new(window.AudioContext||window.webkitAudioContext);fetch(t).then(i=>i.arrayBuffer()).then(i=>e.decodeAudioData(i)).then(i=>{const n=e.createBufferSource();n.buffer=i;const r=e.createGain();r.gain.setValueAtTime(.4,e.currentTime),n.connect(r),r.connect(e.destination),e.state==="suspended"&&e.resume(),n.start(0),n.stop(e.currentTime+Math.min(i.duration,2)),setTimeout(()=>{e.close()},3e3)}).catch(()=>{e.close()})}catch(e){}},[]);o.useCallback(()=>{!g.current||Object.keys(g.current).length===0||Object.entries(g.current).forEach(([t,e])=>{e.paused&&e.currentTime>0&&e.currentTime<e.duration&&e.play().catch(()=>{})})},[]);const $=o.useCallback(()=>{"Notification"in window&&Notification.permission==="granted"&&new Notification("Timer Complete!",{body:"Your 8-minute stretch timer has finished.",icon:"/favicons/favicon-timer.svg",badge:"/favicons/favicon-timer.svg"})},[]),S=t=>{const e=I[t];console.log(`ðŸŽµ Playing gong: ${t} from ${e}`);try{const i=g.current[t];if(i){i.currentTime=0,i.volume=.6;const n=i.play();n!==void 0&&n.then(()=>{console.log(`âœ… Gong ${t} started playing`)}).catch(r=>{console.warn(`âŒ Failed to play gong ${t}:`,r),C(e)})}else console.warn(`âš ï¸ Audio element not found for ${t}, using Web Audio API fallback`),C(e)}catch(i){console.error(`âŒ Error playing gong ${t}:`,i),C(e)}};o.useEffect(()=>{if(s&&d>0){c("START");const t=setInterval(()=>{y(e=>{const i=e-1;return i>0&&i%60===0&&S("minute"),i===4*60&&S("middle"),i===0?(p(!0),v(!1),S("end"),$(),c("STOP"),0):i})},1e3);return()=>{clearInterval(t)}}},[s,d,S,$,c]),o.useEffect(()=>{const t=()=>{!document.hidden&&s&&c("TIMER_SYNC",{timeLeft:d,isRunning:s,isCompleted:b}),c("VISIBILITY_CHANGE",{isVisible:!document.hidden})};return document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[c,s,d,b]),o.useEffect(()=>{if(s){const t=setInterval(()=>{c("TIMER_SYNC",{timeLeft:d,isRunning:s,isCompleted:b})},5e3);return()=>clearInterval(t)}},[s,d,b,c]),o.useEffect(()=>{const t=()=>{c("PAGE_FOCUS")},e=()=>{c("PAGE_BLUR")};return window.addEventListener("focus",t),window.addEventListener("blur",e),()=>{window.removeEventListener("focus",t),window.removeEventListener("blur",e)}},[c]);const P=()=>{d!==0&&(v(!0),p(!1),c("START"))},L=()=>{v(!1),c("STOP")},W=()=>{L(),y(8*60),p(!1),c("RESET")},V=t=>{const e=Math.floor(t/60),i=t%60;return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`};return l.jsx("div",{className:"min-h-screen bg-black flex items-center justify-center p-4",children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"text-8xl font-light text-gray-300 mb-8 font-mono tracking-wider",children:V(d)}),l.jsxs("div",{className:"flex gap-6 justify-center",children:[!s&&d>0&&!b&&l.jsx("button",{onClick:P,className:"w-16 h-16 bg-gray-700 text-gray-200 rounded-full font-medium hover:bg-gray-600 transition-all duration-200 flex items-center justify-center",title:"Start",children:l.jsx("div",{className:"w-0 h-0 border-l-[16px] border-l-gray-200 border-t-[10px] border-t-transparent border-b-[10px] border-b-transparent ml-1"})}),s&&l.jsxs("button",{onClick:L,className:"w-16 h-16 bg-gray-700 text-gray-200 rounded-full font-medium hover:bg-gray-600 transition-all duration-200 flex items-center justify-center gap-1",title:"Pause",children:[l.jsx("div",{className:"w-1.5 h-6 bg-gray-200 rounded-sm"}),l.jsx("div",{className:"w-1.5 h-6 bg-gray-200 rounded-sm"})]}),l.jsx("button",{onClick:W,className:"w-16 h-16 bg-gray-800 text-gray-200 rounded-full font-medium hover:bg-gray-700 transition-all duration-200 flex items-center justify-center text-3xl",title:"Reset",children:"â†º"})]}),l.jsx("div",{className:"mt-6 text-center",children:l.jsxs("span",{className:`inline-block ${A(h).bg} ${A(h).text} text-sm px-4 py-2 rounded-lg font-mono border-2 ${A(h).border} shadow-lg`,children:["ðŸš€ ",h," â€¢ ",u]})})]})})}export{q as TimerPage};
