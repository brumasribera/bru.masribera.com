var x=(c,w,d)=>new Promise((g,u)=>{var p=f=>{try{b(d.next(f))}catch(y){u(y)}},A=f=>{try{b(d.throw(f))}catch(y){u(y)}},b=f=>f.done?g(f.value):Promise.resolve(f.value).then(p,A);b((d=d.apply(c,w)).next())});import{r as a,j as m}from"./index-CSbZwxr1.js";const j={start:"/timer-sounds/start-gong.mp3",middle:"/timer-sounds/middle-gong.mp3",minute:"/timer-sounds/1m-gong.mp3",end:"/timer-sounds/end-gong.mp3"};function G(){const[c,w]=a.useState(480),[d,g]=a.useState(!1),[u,p]=a.useState(!1),[A,b]=a.useState("v1.1.3"),[f,y]=a.useState("2025-08-27 11:45:00"),v=a.useRef({}),E=a.useRef(!1),S=a.useRef({}),C=a.useRef(null);a.useEffect(()=>{fetch("/VERSION.json").then(t=>t.json()).then(t=>{b(`v${t.version}`),y(t.timestamp)}).catch(t=>{console.warn("Failed to load version info:",t)})},[]),a.useEffect(()=>{document.title="Stretch Timer",setTimeout(()=>{document.title="Stretch Timer"},100);const t=()=>{document.hidden||(document.title="Stretch Timer")};return document.addEventListener("visibilitychange",t),(()=>{document.querySelectorAll("link[rel='manifest']").forEach(T=>T.remove());const i=document.createElement("link");i.rel="manifest",i.href=`/tools/timer/manifest.webmanifest?v=${Date.now()}`,i.setAttribute("data-timer-manifest","true"),document.head.appendChild(i),console.log("Timer manifest set to:",i.href),console.log("Current path:",window.location.pathname)})(),(()=>{[{name:"mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-status-bar-style",content:"black-translucent"},{name:"apple-mobile-web-app-title",content:"Stretch Timer"},{name:"application-name",content:"Stretch Timer"},{name:"msapplication-TileColor",content:"#000000"},{name:"msapplication-config",content:"/browserconfig.xml"},{name:"name",content:"Stretch Timer"},{name:"title",content:"Stretch Timer"}].forEach(i=>{if(!document.querySelector(`meta[name="${i.name}"]`)){const o=document.createElement("meta");o.name=i.name,o.content=i.content,document.head.appendChild(o)}})})(),x(this,null,function*(){if("serviceWorker"in navigator)try{const n=yield navigator.serviceWorker.register("/sw.js");console.log("Timer service worker registered:",n),yield navigator.serviceWorker.ready,C.current=n.active,navigator.serviceWorker.addEventListener("message",R)}catch(n){console.error("Timer service worker registration failed:",n)}}),()=>{const n=document.querySelector("link[data-timer-manifest='true']");n&&n.remove();const i=document.createElement("link");i.rel="manifest",i.href="/site.webmanifest",document.head.appendChild(i),console.log("Restored original manifest:",i.href),["mobile-web-app-capable","apple-mobile-web-app-capable","apple-mobile-web-app-status-bar-style","apple-mobile-web-app-title","application-name","msapplication-TileColor","msapplication-config"].forEach(o=>{const k=document.querySelector(`meta[name="${o}"]`);k&&k.remove()}),document.title="Bru Mas Ribera - Frontend & UX Engineer",document.removeEventListener("visibilitychange",t),"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",R),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(o=>{o.forEach(k=>{k.scope.includes("/tools/timer")&&(k.unregister(),console.log("Timer service worker unregistered"))})})}},[]);const R=a.useCallback(t=>{t.data&&t.data.type==="TIMER_UPDATE"&&(w(t.data.timeLeft),g(t.data.isRunning),p(t.data.isCompleted),t.data.gongType&&h(t.data.gongType))},[]),l=a.useCallback((t,e)=>{C.current&&C.current.postMessage({type:"TIMER_CONTROL",action:t,data:e})},[]);a.useEffect(()=>{(()=>{const n=document.querySelector("link[rel*='icon']");if(n)n.dataset.originalHref||(n.dataset.originalHref=n.href),n.href="/favicons/favicon-timer.svg";else{const i=document.createElement("link");i.type="image/svg+xml",i.rel="icon",i.href="/favicons/favicon-timer.svg",document.head.appendChild(i)}})(),x(this,null,function*(){if("Notification"in window&&Notification.permission==="default")try{yield Notification.requestPermission()}catch(n){console.log("Notification permission request failed")}});let r=!0;return x(this,null,function*(){for(const[n,i]of Object.entries(j)){if(!r)break;try{if(!(yield fetch(i)).ok)continue;if(!r)break;const o=q(i);o.addEventListener("error",()=>{}),o.addEventListener("canplaythrough",()=>{}),o.addEventListener("pause",()=>{}),o.addEventListener("play",()=>{}),o.addEventListener("ended",()=>{H()}),v.current[n]=o}catch(T){}}}),()=>{r=!1;const n=document.querySelector("link[rel*='icon']");n&&n.dataset.originalHref?(n.href=n.dataset.originalHref,delete n.dataset.originalHref):n&&n.href.includes("favicon-timer")&&(n.href="/favicon.ico"),Object.values(v.current).forEach(i=>{i.pause(),i.src=""}),v.current={}}},[]);const L=a.useCallback(()=>{const t=document.querySelectorAll("audio");let e=!1;return S.current={},t.forEach((s,n)=>{!s.hasAttribute("data-timer-audio")&&!s.paused&&(e=!0,S.current[`audio_${n}`]={element:s,wasPlaying:!0,currentTime:s.currentTime,volume:s.volume})}),document.querySelectorAll("video").forEach((s,n)=>{!s.paused&&s.volume>0&&(e=!0,S.current[`video_${n}`]={element:s,wasPlaying:!0,currentTime:s.currentTime,volume:s.volume})}),e},[]),H=a.useCallback(()=>{E.current&&setTimeout(()=>{Object.values(S.current).forEach(e=>{if(e.wasPlaying&&e.element)try{if(e.element.tagName==="AUDIO"||e.element.tagName==="VIDEO"){e.element.currentTime=e.currentTime,e.element.volume=e.volume;const r=e.element.play();r!==void 0&&r.catch(()=>{})}}catch(r){}});const t=new Event("resume-audio",{bubbles:!0});document.dispatchEvent(t),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="none",navigator.mediaSession.metadata=null),window.dispatchEvent(new Event("focus")),document.dispatchEvent(new Event("visibilitychange")),E.current=!1,S.current={}},100)},[]);a.useCallback(()=>{"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"Timer Gong",artist:"Stretch Timer",album:"Meditation Sounds"}),navigator.mediaSession.playbackState="none",navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",()=>{}),navigator.mediaSession.setActionHandler("stop",()=>{}),navigator.mediaSession.setActionHandler("seekbackward",()=>{}),navigator.mediaSession.setActionHandler("seekforward",()=>{}),navigator.mediaSession.setActionHandler("seekto",()=>{}),navigator.mediaSession.setActionHandler("previoustrack",()=>{}),navigator.mediaSession.setActionHandler("nexttrack",()=>{}))},[]);const P=a.useCallback(()=>{if("mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"Timer Gong",artist:"Stretch Timer",album:"Meditation Sounds"}),navigator.mediaSession.playbackState="none",navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",()=>{}),navigator.mediaSession.setActionHandler("stop",()=>{}),navigator.mediaSession.setActionHandler("seekbackward",()=>{}),navigator.mediaSession.setActionHandler("seekforward",()=>{}),navigator.mediaSession.setActionHandler("seekto",()=>{}),navigator.mediaSession.setActionHandler("previoustrack",()=>{}),navigator.mediaSession.setActionHandler("nexttrack",()=>{}),"setAudioFocusRequest"in navigator.mediaSession))try{navigator.mediaSession.setAudioFocusRequest({audioFocusRequestType:"transient_may_duck"})}catch(t){}},[]),q=a.useCallback(t=>{const e=new Audio(t);return e.preload="auto",e.volume=.5,e.loop=!1,e.setAttribute("data-timer-audio","true"),e.setAttribute("data-notification-style","true"),e.addEventListener("loadedmetadata",()=>{e.duration>3&&e.addEventListener("timeupdate",()=>{e.currentTime>=3&&(e.pause(),e.currentTime=0)})}),e},[]),O=a.useCallback(t=>{try{const e=new(window.AudioContext||window.webkitAudioContext);fetch(t).then(r=>r.arrayBuffer()).then(r=>e.decodeAudioData(r)).then(r=>{const s=e.createBufferSource();s.buffer=r;const n=e.createGain();n.gain.setValueAtTime(.4,e.currentTime),s.connect(n),n.connect(e.destination),e.state==="suspended"&&e.resume(),s.start(0),s.stop(e.currentTime+Math.min(r.duration,2)),setTimeout(()=>{e.close()},3e3)}).catch(()=>{e.close()})}catch(e){}},[]);a.useCallback(()=>{!v.current||Object.keys(v.current).length===0||Object.entries(v.current).forEach(([t,e])=>{e.paused&&e.currentTime>0&&e.currentTime<e.duration&&e.play().catch(()=>{})})},[]);const N=a.useCallback(()=>{if("Notification"in window&&Notification.permission==="granted")try{new Notification("Stretch Timer Complete! 🧘‍♀️",{body:"Your 8-minute stretch session is finished. Time to get back to work!",icon:"/favicons/favicon-timer.svg",badge:"/favicons/favicon-timer.svg",tag:"stretch-timer",requireInteraction:!0,silent:!1})}catch(t){console.log("Failed to send notification:",t)}},[]),h=t=>{const e=j[t];try{E.current||(E.current=L()),O(e);const r=v.current[t];if(r){P(),r.currentTime=0,r.volume=.4;const s=r.play();s!==void 0&&s.then(()=>{"mediaSession"in navigator&&(navigator.mediaSession.playbackState="none",setTimeout(()=>{"mediaSession"in navigator&&(navigator.mediaSession.metadata=null)},100))}).catch(n=>{})}}catch(r){}};a.useEffect(()=>(d&&c>0?requestAnimationFrame(e=>{l("TIMER_SYNC",{timeLeft:c,isRunning:d,isCompleted:u}),c>0&&c%60===0&&!u&&h("minute"),c===240&&!u&&h("middle"),c===0&&!u&&(p(!0),g(!1),h("end"),N(),l("TIMER_SYNC",{timeLeft:0,isRunning:!1,isCompleted:!0}))}):c===0&&!u&&(p(!0),g(!1),h("end"),N(),l("TIMER_SYNC",{timeLeft:0,isRunning:!1,isCompleted:!0})),()=>{}),[d,c,u,l,h,N]),a.useEffect(()=>{const t=()=>{l("VISIBILITY_CHANGE",{isVisible:!document.hidden})};return document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[l]),a.useEffect(()=>{const t=()=>{l("PAGE_FOCUS")},e=()=>{l("PAGE_BLUR")};return window.addEventListener("focus",t),window.addEventListener("blur",e),()=>{window.removeEventListener("focus",t),window.removeEventListener("blur",e)}},[l]);const I=()=>{c!==0&&(g(!0),p(!1),l("START"))},M=()=>{g(!1),l("STOP")},W=()=>{M(),w(8*60),p(!1),l("RESET")},F=t=>{const e=Math.floor(t/60),r=t%60;return`${e.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`};return m.jsx("div",{className:"min-h-screen bg-black flex items-center justify-center p-4",children:m.jsxs("div",{className:"text-center",children:[m.jsx("div",{className:"text-8xl font-light text-gray-300 mb-8 font-mono tracking-wider",children:F(c)}),m.jsxs("div",{className:"flex gap-6 justify-center",children:[!d&&c>0&&!u&&m.jsx("button",{onClick:I,className:"w-16 h-16 bg-gray-700 text-gray-200 rounded-full font-medium hover:bg-gray-600 transition-all duration-200 flex items-center justify-center",title:"Start",children:m.jsx("div",{className:"w-0 h-0 border-l-[16px] border-l-gray-200 border-t-[10px] border-t-transparent border-b-[10px] border-b-transparent ml-1"})}),d&&m.jsxs("button",{onClick:M,className:"w-16 h-16 bg-gray-700 text-gray-200 rounded-full font-medium hover:bg-gray-600 transition-all duration-200 flex items-center justify-center gap-1",title:"Pause",children:[m.jsx("div",{className:"w-1.5 h-6 bg-gray-200 rounded-sm"}),m.jsx("div",{className:"w-1.5 h-6 bg-gray-200 rounded-sm"})]}),m.jsx("button",{onClick:W,className:"w-16 h-16 bg-gray-800 text-gray-200 rounded-full font-medium hover:bg-gray-700 transition-all duration-200 flex items-center justify-center text-3xl",title:"Reset",children:"↺"})]}),m.jsx("div",{className:"mt-6 text-center",children:m.jsxs("span",{className:"inline-block bg-blue-600 text-white text-sm px-4 py-2 rounded-lg font-mono border-2 border-blue-400 shadow-lg",children:["🚀 ",A," • ",f]})})]})})}export{G as TimerPage};
